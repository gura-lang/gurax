#!/usr/bin/env gurax
import(util.tester) {*}
import(tar)

TestCase('Property') {
	tar.Stat.PrintPropSlots()
	tar.Reader.PrintPropSlots()
	tar.Writer.PrintPropSlots()
	tar.bzip2.PrintPropSlots()
	tar.gzip.PrintPropSlots()
}

TestCase('archive test') {
	entries = [
		b'a' * 38009
		b'b' * 43643
		b'c' * 33517
		b'd' * 26822
		b'e' * 512
		b'f' * 28838
		b'g' * 2048
		b'h' * 24991
		b'i' * 38910
		b'j' * 56954
	]
	//for (compress in [`gzip, `bzip2]) {
	/*
	tar.Writer('test.tar.bz2') {|w|
		w.Add(entries, 'entry' + ((0..) + 1) + '.bin')
	}
	for (entry in entries, stream in tar.Reader('test.tar.bz2').EachEntry()) {
		entryDec = stream.Read()
		Printf('%-12s %5d %5d\n', stream.identifier, stream.stat.size, entryDec.bytes)
	}
	*/
	for (compress in [`none, `gzip, `bzip2]) {
		Printf('tar compression: %s\n', compress)
		buff = Binary()
		tar.Writer(buff, compress).Add(entries, 'entry' + ((0..) + 1) + '.bin')
		for (entry in entries, stream in tar.Reader(buff, compress).EachEntry()) {
			entryDec = stream.Read()
			Printf('%-12s %5d %s\n', stream.identifier, stream.stat.size,
										cond(entry == entryDec, 'OK', '*NG*'))
		}
	}
}
