#!/usr/bin/env gurax
import(util.tester) {*}
import(tar)

TestCase('Property') {
	tar.Stat.PrintPropSlots()
	tar.Reader.PrintPropSlots()
	tar.Writer.PrintPropSlots()
	tar.bzip2.PrintPropSlots()
	tar.gzip.PrintPropSlots()
}

TestCase('Archive test') {
	Entry = struct { fileName:String, buff:Binary }
	r = Random(0)
	entries = repeat (100):list {|i|
		buff = Binary()
		buff.p.Put(`uint8, r.IntSeq(256, r.Int(50000) + 1))
		Entry(Format('entry%d.bin', i + 1), buff)
	}
	for (compress in [`none, `gzip, `bzip2]) {
		Printf('tar compression: %s\n', compress)
		buff = Binary()
		tar.Writer(buff, compress).Add(entries:*buff, entries:*fileName)
		for (entry in entries, stream in tar.Reader(buff, compress).EachEntry()) {
			buffRead = stream.Read()
			Printf('%-12s %5dbytes Verify:%s\n', stream.identifier, stream.stat.size,
										cond(entry.buff == buffRead, 'OK', '*NG*'))
		}
	}
}

