#!/usr/bin/env gurax
//=============================================================================
// markdown module
// The markdown module consists of the binary and script part, and this is
// the script part that mainly provides rendering functions.
//=============================================================================
import(re)
import(markdown):binary {*}

MakeAnchorNameDef(indices[]:Number) = 'anchor-' + Format('%d', indices).join('-')


/*
Renderer@tex = class {
	tmpl@header = R'''
	\documentclass{report}
	${if (!_this.title.isempty())}
	\title{${_this.title}}
	${end}
	${if (!_this.author.isempty())}
	\author{${_this.author}}
	${end}
	${if (!_this.date.isempty())}
	\date{${_this.date}}
	${end}
	\usepackage{fancyvrb}
	\usepackage{tabulary}
	\usepackage[dvipdfmx,setpagesize=false]{hyperref}
	\usepackage{listings}
	\usepackage{enumitem}
	\lstset{
	basicstyle=\small\ttfamily,
	columns=flexible,
	breaklines=true
	}
	\setlength{\textwidth}{145mm}
	\setlength{\oddsidemargin}{35mm}
	\addtolength{\oddsidemargin}{-1in}
	\setlength{\parindent}{0mm}
	\setlength{\parskip}{2mm}
	\setlength{\textheight}{244mm}
	\setlength{\headheight}{0mm}
	\setlength{\headsep}{25mm}
	\setlength{\footskip}{15mm}
	\addtolength{\topmargin}{-1in}
	\begin{document}
	${if (!_this.title.isempty())}
	\maketitle
	\tableofcontents
	${end}
	'''T
	tmpl@footer = R'''
	\end{document}
	'''T
	__init__(out:stream:w, title:string, author:string, date:string) = {
		this.out = out
		this.title = title
		this.author = author
		this.date = date
		this.escapeTextFlag = true
		this.indentLeft = 0
		this.insideTableFlag = false
		this.idxItem = 0
		this.listType = nil
	}
	Render(doc:Document):void = {
		this.RenderItem(doc.root)
	}
	RenderItem(item:Item):map:void = {
		!this.OnRenderItemPre(item) && return
		if (item.type == `root) {
			_this = this
			tmpl@header.render(this.out)
			this.RenderItem(item.children)
			tmpl@footer.render(this.out)
		} elsif (item.type == `h1) {
			this.out.Print(r'\chapter{')
			this.RenderItem(item.children)
			this.out.Println(r'}')
		} elsif (item.type == `h2) {
			this.out.Print(r'\section{')
			this.RenderItem(item.children)
			this.out.Println(r'}')
		} elsif (item.type == `h3) {
			this.out.Print(r'\subsection{')
			this.RenderItem(item.children)
			this.out.Println(r'}')
		} elsif (item.type == `h4) {
			this.out.Print(r'\subsubsection{')
			this.RenderItem(item.children)
			this.out.Println(r'}')
		} elsif (item.type == `h5) {
			this.out.Print(r'\paragraph{')
			this.RenderItem(item.children)
			this.out.Println(r'}')
		} elsif (item.type == `h6) {
			this.out.Print(r'\paragraph{')
			this.RenderItem(item.children)
			this.out.Println(r'}')
		} elsif (item.type == `p) {
			this.RenderItem(item.children)
			this.out.Println()
			this.out.Println()
		} elsif (item.type == `blockquote) {
			this.out.Println(r'\begin{quotation}')
			this.RenderItem(item.children)
			this.out.Println(r'\end{quotation}')
		} elsif (item.type == `em) {
			this.out.Print(r'{\it ')
			this.RenderItem(item.children)
			this.out.Print(r'}')
		} elsif (item.type == `strong) {
			this.out.Print(r'{\bf ')
			this.RenderItem(item.children)
			this.out.Print(r'}')
		} elsif (item.type == `strike) {
			this.RenderItem(item.children)
		} elsif (item.type == `codeblock) {
			this.out.Printf(
					r'\begin{lstlisting}[frame=single,aboveskip=\bigskipamount,' \
					r'xleftmargin=%dpt,xrightmargin=4pt]' '\n', this.indentLeft + 4)
			this.escapeTextFlag = false
			this.RenderItem(item.children)
			this.escapeTextFlag = true
			this.out.Println(r'\end{lstlisting}')
		} elsif (item.type == `ol) {
			if (this.insideTableFlag) {
				this.idxItem = 0
				this.listType = `ol
				this.RenderItem(item.children)
				this.out.Println()
			} else {
				this.out.Println(r'\begin{enumerate}[itemsep=0pt]')
				this.RenderItem(item.children)
				this.out.Println(r'\end{enumerate}')
			}
		} elsif (item.type == `ul) {
			if (this.insideTableFlag) {
				this.idxItem = 0
				this.listType = `ul
				this.RenderItem(item.children)
				this.out.Println()
			} else {
				this.out.Println(r'\begin{itemize}[itemsep=0pt]')
				this.RenderItem(item.children)
				this.out.Println(r'\end{itemize}')
			}
		} elsif (item.type == `li) {
			if (this.insideTableFlag) {
				(this.idxItem > 0) && this.out.Println(r'\newline')
				this.idxItem += 1
				if (this.listType == `ol) {
					this.out.Printf(r'%d. ', this.idxItem)
				} else {
					this.out.Print(r'$\bullet$ ')
				}
				this.RenderItem(item.children)
				this.out.Println()
			} else {
				this.out.Print(r'\item ')
				this.RenderItem(item.children)
				this.out.Println()
			}
		} elsif (item.type == `line) {
			this.RenderItem(item.children)
			this.out.Println()
		} elsif (item.type == `a) {
			this.RenderItem(item.children)
		} elsif (item.type == `img) {
			
		} elsif (item.type == `text) {
			if (this.escapeTextFlag) {
				this.out.Print(this.EscapeText(item.text))
			} else {
				this.out.Print(item.text)
			}
		} elsif (item.type == `comment) {
			// nothing to do
		} elsif (item.type == `code) {
			this.out.Print(r'{\tt ')
			this.out.Print(this.EscapeText(item.text))
			this.out.Print(r'}')
		} elsif (item.type == `entity) {
			if (item.text == 'hellip') {
				this.out.Print(r'\textellipsis ')
			}
			//this.out.Print(r'\u%d?', 169)
		} elsif (item.type == `tag) {
			tagName = item.text.lower()
			if (item.text == 'gura.funcentry') {
				fmt = if (m = item.attrs.match(r'format="([^\"]+)"')) {m[1]} else {''}
				this.out.Println(r'\begin{lstlisting}[aboveskip=\bigskipamount,belowskip=0pt]')
				this.out.Println(fmt.unescapehtml())
				this.out.Println(r'\end{lstlisting}')
				if (item.children) {
					this.out.Println(r'{\setlength{\leftskip}{16pt}')
					this.indentLeft += 16
					this.RenderItem(item.children)
					this.indentLeft -= 16
					this.out.Println(r'\par}')
					this.out.Println()
				}
			} elsif (item.text == 'gura.propentry') {
				fmt = if (m = item.attrs.match(r'format="([^\"]+)"')) {m[1]} else {''}
				typeName = if (m = item.attrs.match(r'type="([^\"]+)"')) {m[1]} else {''}
				accessMode = if (m = item.attrs.match(r'access="([^\"]+)"')) {m[1]} else {''}
				this.out.Println(r'\bigskip')
				this.out.Printf(r'{\small\tt %s} \ldots {\small{\tt %s} [%s]}' '\n\n',
								this.EscapeText(fmt.unescapehtml()),
								this.EscapeText(typeName.unescapehtml()),
								this.EscapeText(accessMode.unescapehtml()))
				if (item.children) {
					this.out.Println(r'{\setlength{\leftskip}{16pt}')
					this.indentLeft += 16
					this.RenderItem(item.children)
					this.indentLeft -= 16
					this.out.Println(r'\par}')
					this.out.Println()
				}
			} elsif (tagName == 'table') {
				this.insideTableFlag = true
				this.RenderTable(item)
				this.insideTableFlag = false
			} elsif (tagName == 'code') {
				this.out.Print(r'{\tt ')
				item.children && this.RenderItem(item.children)
				this.out.Print(r'}')
			} elsif (tagName == 'em') {
				this.out.Print(r'{\it ')
				item.children && this.RenderItem(item.children)
				this.out.Print(r'}')
			} elsif (tagName == 'strong') {
				this.out.Print(r'{\bf ')
				item.children && this.RenderItem(item.children)
				this.out.Print(r'}')
			} else {
				item.children && this.RenderItem(item.children)
			}
		} elsif (item.type == `hr) {
			
		} elsif (item.type == `br) {
			this.out.Println(r'\newline')
		}
		this.OnRenderItemPost(item)
	}
	replaceTbl = [
		'\\', r'$\backslash$',
		'#', r'\#',
		'$', r'\$',
		'%', r'\%',
		'&', r'\&',
		'_', r'\_',
		'{', r'\{',
		'}', r'\}',
		'^', r'$\wedge$',
		'*', r'$\ast$'
	]
	EscapeText(text:string):static = text.replaces(replaceTbl)
	RenderTable(item:Item) = {
		rows = item.children.each():xlist {|item|
			(item.type != `tag || item.text.lower() != 'tr') && continue
			headerFlag = false
			item.children.each():xlist {|item|
				(item.type != `tag) && continue
				tagName = item.text.lower()
				if (tagName == 'th') {
					headerFlag = true
				} elsif (tagName == 'td') {
					// nothing to do
				} else {
					continue
				}
				item
			}
		}
		alignChars = %{`left = 'L', `right = 'R', `center = 'C'}
		aligns = rows[0]::align
		alignSpecifier = [
			alignChars.get(aligns.head(aligns.len() - 1), 'L')
			alignChars.get(aligns.last(), 'J')
		].join('|')
		this.out.Println()
		this.out.Printf(R'''
		\medskip
		\begin{center}
		\begin{tabulary}{\textwidth}{|%s|} \hline
		''', alignSpecifier)
		rows.each {|cols, iRow|
			headerFlag = false
			cols.each {|item, iCol|
				(iCol > 0) && this.out.Print(' & ')
				if (item.text.lower() == 'th') {
					this.out.Print(r'\textbf{')
					this.RenderItem(item)
					this.out.Print(r'}')
					headerFlag = true
				} else {
					this.RenderItem(item)
				}
			}
			if (headerFlag || iRow == rows.len() - 1) {
				this.out.Println(r' \\ \hline')
			} else {
				this.out.Println(r' \\')
			}
		}
		this.out.Print(R'''
		\end{tabulary}
		\end{center}
		\medskip
		''')
	}
	OnRenderItemPre(item:Item) = true
	OnRenderItemPost(item:Item):void = nil
}

Renderer@rtf = class {
	header = R'''
	{\rtf1\ansi\ansicpg932
	{\fonttbl\f0\fswiss\fcharset0 Helvetica;\f1\fscript\fcharset0 Menlo-Regular;}
	{\colortbl;\red255\green255\blue255;\red207\green207\blue207;\red172\green172\blue172;\red191\green191\blue191;}
	\paperw11900\paperh16840\margl1440\margr1440\vieww10800\viewh13240\viewkind5
	'''
	footer = R'''
	}
	'''
	__init__(out:stream:w, captionIndex:Bool) = {
		this.out = out
		this.captionIndex = captionIndex
		this.indentLeft = 0
		this.listLevel = 0
		this.indentPerList = 360
		this.indentPerQuote = 360
		this.indices = dim(6) {0}
	}
	Render(doc:Document):void = {
		this.RenderItem(doc.root)
	}
	RenderItem(item:Item):map:void = {
		if (item.type == `root) {
			this.out.Print(header)
			this.RenderCoverPage()
			this.RenderItem(item.children)
			this.out.Print(footer)
		} elsif (item.type == `h1) {
			this.out.Printf(r'{\pard\ql\f0\sa180\sb360\li%d\fi0\b\fs36 ', this.indentLeft)
			if (this.captionIndex) {
				this.indices[0] += 1
				this.indices[1..5] = 0
				this.out.Printf('%d ', this.indices[0])
			}
			this.RenderItem(item.children)
			this.out.Println(r'\par}')
		} elsif (item.type == `h2) {
			this.out.Printf(r'{\pard\ql\f0\sa180\sb180\li%d\fi0\b\fs32 ', this.indentLeft)
			if (this.captionIndex) {
				this.indices[1] += 1
				this.indices[2..5] = 0
				this.out.Printf('%d.%d ', this.indices[0..1]*)
			}
			this.RenderItem(item.children)
			this.out.Println(r'\par}')
		} elsif (item.type == `h3) {
			this.out.Printf(r'{\pard\ql\f0\sa180\li%d\fi0\b\fs28 ', this.indentLeft)
			if (this.captionIndex) {
				this.indices[2] += 1
				this.indices[3..5] = 0
				this.out.Printf('%d.%d.%d ', this.indices[0..2]*)
			}
			this.RenderItem(item.children)
			this.out.Println(r'\par}')
		} elsif (item.type == `h4) {
			this.out.Printf(r'{\pard\ql\f0\sa180\li%d\fi0\b\fs24 ', this.indentLeft)
			if (this.captionIndex) {
				this.indices[3] += 1
				this.indices[4..5] = 0
				this.out.Printf('%d.%d.%d.%d ', this.indices[0..3]*)
			}
			this.RenderItem(item.children)
			this.out.Println(r'\par}')
		} elsif (item.type == `h5) {
			this.out.Printf(r'{\pard\ql\f0\sa180\li%d\fi0\b\fs20 ', this.indentLeft)
			if (this.captionIndex) {
				this.indices[4] += 1
				this.indices[5] = 0
				this.out.Printf('%d.%d.%d.%d.%d ', this.indices[0..4]*)
			}
			this.RenderItem(item.children)
			this.out.Println(r'\par}')
		} elsif (item.type == `h6) {
			this.out.Printf(r'{\pard\ql\f0\sa180\li%d\fi0\b\fs20 ', this.indentLeft)
			if (this.captionIndex) {
				this.indices[5] += 1
				this.out.Printf('%d.%d.%d.%d.%d.%d ', this.indices[0..5]*)
			}
			this.RenderItem(item.children)
			this.out.Println(r'\par}')
		} elsif (item.type == `p) {
			this.out.Printf(r'{\pard\ql\f0\sa180\li%d\fi0\fs20 ', this.indentLeft)
			this.RenderItem(item.children)
			this.out.Println()
			this.out.Println(r'\par}')
		} elsif (item.type == `blockquote) {
			this.indentLeft += this.indentPerQuote
			this.RenderItem(item.children)
			this.out.Println()
			this.indentLeft -= this.indentPerQuote
		} elsif (item.type == `em) {
			this.out.Print(r'{\i ')
			this.RenderItem(item.children)
			this.out.Print(r'}')
		} elsif (item.type == `strong) {
			this.out.Print(r'{\b ')
			this.RenderItem(item.children)
			this.out.Print(r'}')
		} elsif (item.type == `strike) {
			this.out.Print(r'{\strike ')
			this.RenderItem(item.children)
			this.out.Print(r'}')
		} elsif (item.type == `codeblock) {
			this.out.Print(R'''
			{\pard\itap1\trowd \taflags1 \trbrdrt\brdrnil \trbrdrl\brdrnil \trbrdrt\brdrnil \trbrdrr\brdrnil 
			\clvertalc \clshdrawnil \clbrdrt\brdrs\brdrw20\brdrcf2 \clbrdrl\brdrs\brdrw20\brdrcf2 \clbrdrb\brdrs\brdrw20\brdrcf2 \clbrdrr\brdrs\brdrw20\brdrcf2 \clpadt150\clpadb150\clpadl150\clpadr150 \gaph\cellx8640
			\f1\fs20
			''')
			item.children.each {|itemChild, i|
				(i > 0) && this.out.Println(r'\line')
				this.RenderItem(itemChild.children)
			}
			this.out.Println(r'\cell \lastrow\row\par}')
		} elsif (item.type == `ol) {
			this.RenderListItem(item)
		} elsif (item.type == `ul) {
			this.RenderListItem(item)
		} elsif (item.type == `li) {
			// nothing to do here
		} elsif (item.type == `line) {
			this.RenderItem(item.children)
			this.out.Println(r'\line')
		} elsif (item.type == `a) {
			this.out.Println(r'{\field{\*\fldinst{HYPERLINK "%s"}}{\fldrslt{\ul' % this.EscapeText(item.url))
			this.RenderItem(item.children)
			this.out.Println(r'}}}')
		} elsif (item.type == `img) {
			//this.out.Print('<img')
			//item.url && this.out.Print(' src="', item.url.encodeuri(), '"')
			//item.text && this.out.Print(' alt="', item.text.escapehtml(), '"')
			//item.title && this.out.Print(' title="', item.title.escapehtml(), '"')
			//this.out.Print('>')
		} elsif (item.type == `text) {
			this.out.Print(this.EscapeText(item.text))
		} elsif (item.type == `comment) {
			this.out.Print(item.text)
		} elsif (item.type == `code) {
			this.out.Print(r'{\f1\fs20 ')
			this.out.Print(this.EscapeText(item.text))
			this.out.Print(r'}')
		} elsif (item.type == `entity) {
			this.out.Printf(r'\u%d?', 169)
		} elsif (item.type == `tag) {
			if (item.text == 'gura.funcentry') {
				fmt = if (m = item.attrs.match(r'format="([^\"]+)"')) {m[1]} else {''}
				this.out.Printf(r'{\pard\ql\f1\sa180\li%d\fi0\b\fs20 ', this.indentLeft)
				this.out.Print(this.EscapeText(fmt.unescapehtml()))
				this.out.Println(r'\par}')
				if (item.children) {
					this.indentLeft += this.indentPerQuote
					this.RenderItem(item.children)
					this.out.Println()
					this.indentLeft -= this.indentPerQuote
				}
			} elsif (item.text == 'gura.propentry') {
				
			} elsif (item.text == 'table') {
				this.RenderTable(item)
			} elsif (item.text == 'code') {
				this.out.Print(r'{\f1\fs20 ')
				item.children && this.RenderItem(item.children)
				this.out.Print(r'}')
			} elsif (item.text == 'em') {
				this.out.Print(r'{\i ')
				item.children && this.RenderItem(item.children)
				this.out.Print(r'}')
			} elsif (item.text == 'strong') {
				this.out.Print(r'{\b ')
				item.children && this.RenderItem(item.children)
				this.out.Print(r'}')
			} else {
				item.children && this.RenderItem(item.children)
			}
		} elsif (item.type == `hr) {
			this.out.Printf(r'{\pard\qc\f0\sa180\li%d\fi0\emdash\emdash\emdash\emdash\emdash\par}' '\n',
							this.indentLeft)
		} elsif (item.type == `br) {
			this.out.Println(r'\line')
		}
	}
	EscapeText(text:string):static = {
		text.replace('\\', '\\\\').replace('{', r'\{').replace('}', r'\}')
	}
	RenderListItem(item:Item) = {
		parRenderFlag = false
		this.listLevel += 1
		item.children.each {|itemChild, i|
			(i > 0 && !parRenderFlag) && this.out.Println(r'\par}')
			if (item.type == `ul) {
				this.out.Print(r'{\pard\ql\f0\sa0\li%d\fi-360\fs20 \bullet \tx360\tab ' % \
							[this.indentLeft + this.indentPerList * this.listLevel + 100])
			} else { // item.type == `ol
				this.out.Print(r'{\pard\ql\f0\sa0\li%d\fi-360\fs20 %d. \tx360\tab ' % \
							[this.indentLeft + this.indentPerList * this.listLevel + 100, i + 1])
			}
			parRenderFlag = false
			itemChild.children.each {|itemDescend, i|
				if (itemDescend.type == `ol || itemDescend.type == `ul) {
					this.out.Println(r'\sa180\par}')
					parRenderFlag = true
				}
				this.RenderItem(itemDescend)
			}
			
		}
		!parRenderFlag && this.out.Println(r'\sa180\par}')
		this.listLevel -= 1
	}
	RenderTable(item:Item) = {
		rows = item.children.each():xlist {|item|
			(item.type != `tag || item.text.lower() != 'tr') && continue
			headerFlag = false
			item.children.each():xlist {|item|
				(item.type != `tag) && continue
				tagName = item.text.lower()
				if (tagName == 'th') {
					headerFlag = true
				} elsif (tagName == 'td') {
					// nothing to do
				} else {
					continue
				}
				item
			}
		}
		alignChars = %{`left = 'L', `right = 'R', `center = 'C'}
		aligns = rows[0]::align
		alignSpecifier = [
			alignChars.get(aligns.head(aligns.len() - 1), 'L')
			alignChars.get(aligns.last(), 'J')
		].join('|')
		this.out.Println()
		this.out.Printf(r'{\pard\ql\f0\sa180\li%d\fi0\fs20 ', this.indentLeft)
		rows.each {|cols, iRow|
			headerFlag = false
			wdCols = dim(cols.len()) {2000}
			this.out.Println(r'\itap1\trowd \taflags1 \trgaph108\trleft-108 \trbrdrl\brdrnil \trbrdrr\brdrnil')
			x = 0
			wdCols.each {|wdCol|
				this.out.Printf(r'\clvertalc \clshdrawnil \clbrdrt\brdrs\brdrw20\brdrcf2 \clbrdrl\brdrs\brdrw20\brdrcf2 \clbrdrb\brdrs\brdrw20\brdrcf2 \clbrdrr\brdrs\brdrw20\brdrcf2 \clpadl100 \clpadr100 \gaph\cellx%d' '\n', x)
				//this.out.Printf(r'\clvertalc \clshdrawnil \clwWidth%d\clftsWidth3 \clbrdrt\brdrs\brdrw20\brdrcf2 \clbrdrl\brdrs\brdrw20\brdrcf2 \clbrdrb\brdrs\brdrw20\brdrcf2 \clbrdrr\brdrs\brdrw20\brdrcf2 \clpadl100 \clpadr100 \gaph\cellx%d' '\n', wdCol, x)
				x += wdCol
			}
			cols.each {|item, iCol|
				if (iCol > 0) { this.out.Println() }
				this.out.Print(R'''
				\pard\intbl\itap1
				\cf0 ''')
				if (item.text.lower() == 'th') {
					this.RenderItem(item)
					headerFlag = true
				} else {
					this.RenderItem(item)
				}
				this.out.Print(r'\cell')
			}
			if (iRow < rows.len() - 1) {
				this.out.Println(r' \row')
			} else {
				this.out.Println(r' \lastrow\row')
			}
		}
		this.out.Println(r'\par}')
	}
	RenderCoverPage() = {}
}

Renderer@console = class {
	__init__(colorFlag:Bool = true) = {
		[this.wdScreen, this.htScreen] = conio.getwinsize()
		if (this.wdScreen == 0) {
			this.wdScreen = 80
		}
		this.wdScreen -= 1
		if (this.htScreen == 0) {
			this.htScreen = 25
		}
		this.indexStack = []
		if (colorFlag) {
			this.setcolor = conio.setcolor
		} else {
			this.setcolor(color:color) {block} = block()
		}
	}
	Render(doc:Document):void = {
		this.firstFlag = true
		this.RenderItem(doc.root)
	}
	RenderItem(item:Item):map:void = {
		if (item.type == `root) {
			this.RenderItem(item.children)
		} elsif (item.type == `h1) {
			this.PrintlnConditional()
			this.setcolor(`green) {
				this.RenderItem(item.children)
			}
			Println()
		} elsif (item.type == `h2) {
			this.PrintlnConditional()
			this.setcolor(`green) {
				this.RenderItem(item.children)
			}
			Println()
		} elsif (item.type == `h3) {
			this.PrintlnConditional()
			this.setcolor(`green) {
				this.RenderItem(item.children)
			}
			Println()
		} elsif (item.type == `h4) {
			this.PrintlnConditional()
			this.setcolor(`green) {
				this.RenderItem(item.children)
			}
			Println()
		} elsif (item.type == `h5) {
			this.PrintlnConditional()
			this.setcolor(`green) {
				this.RenderItem(item.children)
			}
			Println()
		} elsif (item.type == `h6) {
			this.PrintlnConditional()
			this.setcolor(`green) {
				this.RenderItem(item.children)
			}
			Println()
		} elsif (item.type == `p) {
			this.PrintlnConditional()
			this.RenderItem(item.children)
			Println()
		} elsif (item.type == `blockquote) {
			this.PrintlnConditional()
			this.RenderItem(item.children)
			Println()
		} elsif (item.type == `em) {
			this.setcolor(`red) {
				this.RenderItem(item.children)
			}
		} elsif (item.type == `strong) {
			this.setcolor(`red) {
				this.RenderItem(item.children)
			}
		} elsif (item.type == `strike) {
			this.setcolor(`gray) {
				this.RenderItem(item.children)
			}
		} elsif (item.type == `codeblock) {
			this.PrintlnConditional()
			this.setcolor(`blue) {
				this.RenderItem(item.children)
			}
		} elsif (item.type == `ol) {
			this.PrintlnConditional()
			this.indexStack.add(0)
			this.RenderItem(item.children)
			this.indexStack.erase(-1)
		} elsif (item.type == `ul) {
			this.PrintlnConditional()
			this.indexStack.add(nil)
			this.RenderItem(item.children)
			this.indexStack.erase(-1)
		} elsif (item.type == `li) {
			(this.indexStack.len() > 0) && Print('  ' * (this.indexStack.len() - 1))
			index = this.indexStack[-1]
			if (index) {
				Printf('%d. ', index + 1)
				this.indexStack[-1] += 1
			} else {
				Print('- ')
			}
			this.RenderItem(item.children)
			Println()
		} elsif (item.type == `line) {
			Print('|   ')
			this.RenderItem(item.children)
			Println()
		} elsif (item.type == `a) {
			this.RenderItem(item.children)
		} elsif (item.type == `img) {
			Print('[', item.text, ']')
		} elsif (item.type == `text) {
			Print(item.text)
		} elsif (item.type == `comment) {
			Print(item.text)
		} elsif (item.type == `code) {
			this.setcolor(`blue) {
				Print(item.text)
			}
		} elsif (item.type == `entity) {
			this.setcolor(`black, `white) {
				Print(item.text.escapehtml())
			}
		} elsif (item.type == `tag) {
			text = item.text.lower()
			if (text == 'table') {
				this.RenderTable(item)
			} elsif (text == 'gura.funcentry') {
				fmt = if (m = item.attrs.match(r'format="([^\"]+)"')) {m[1]} else {''}
				Println(fmt)
				Println('-' * fmt.len())
				item.children && this.RenderItem(item.children)
			} else {
				item.children && this.RenderItem(item.children)
			}
		} elsif (item.type == `hr) {
			Println('--------')
		} elsif (item.type == `br) {
			Println()
		}
	}
	PrintlnConditional() = {
		if (this.firstFlag) {
			this.firstFlag = false
		} else {
			Println()
		}
	}
	RenderTable(item:Item) = {
		rows = item.children.each():xlist {|item|
			(item.type != `tag || item.text.lower() != 'tr') && continue
			headerFlag = false
			cols = item.children.each():xlist {|item|
				(item.type != `tag) && continue
				tagName = item.text.lower()
				if (tagName == 'th') {
					headerFlag = true
				} elsif (tagName == 'td') {
					// nothing to do
				} else {
					continue
				}
				TableCol(JoinText(item), item.align)
			}
			TableRow(headerFlag, cols)
		}
		nCols = rows:*cols:*len().max()
		rows::cols = rows:*cols::align(nCols, TableCol('', `left)):list
		widths = repeat(nCols):list {|iCol|
			rows:*cols:*get(iCol):*text:*len().max()
		}
		wdAvailable = this.wdScreen + 1 - nCols // subtract width for vertical bar
		wdThreshold = int(wdAvailable / nCols)
		wdSum = widths.sum()
		if (wdSum > wdAvailable) {
			widthsShort = widths.filter(widths < wdThreshold)
			widthsShortSum = widthsShort.sum() || 0
			widthsLongSum = wdSum - widthsShortSum
			wdRest = wdAvailable - widthsShortSum
			if (wdRest < 0) {
				widthsWk = int(widths * wdAvailable / wdSum)
			} else {
				widthsWk = widths.each():list {|width|
					if (width < wdThreshold) {
						width
					} else {
						width * wdRest / widthsLongSum
					}
				}
			}
			if ((widthsWk > 0).and()) {
				widths = widthsWk
			}
		}
		separator = ('-' * widths).join('+')
		rows.each {|row|
			textsFolded = row.cols:*text.each():list {|text, i|
				text.split('\n'):*foldw(widths[i]).flatten().each()
			}
			while ((texts = textsFolded:*next()).or()) {
				//Println(format('%-*s', widths, texts || '').join('|'))
				Println(this.MakeAlign(texts || '', widths, row.cols:*align).join('|'))
			}
			row.headerFlag && Println(separator)
		}
	}
	MakeAlign(str:string, width:number, align:symbol):map:static = {
		if (align == `left) {
			str.align(width):left
		} elsif (align == `center) {
			str.align(width):center
		} elsif (align == `right) {
			str.align(width):right
		} else {	
			str.align(width):left
		}
	}
}

TableCol = struct(text:string, align:symbol)
TableRow = struct(headerFlag:Bool, cols[]:TableCol)

JoinText(item:Item):map = {
	if (item.children) {
		JoinText(item.children).join()
	} else {
		item.text
	}
}

Renderer@toc = class {
	__init__(handler:function) = {
		this.handler = handler
		this.text = nil
		this.indices = dim(6) {0}
	}
	Render(doc:Document):void = {
		this.RenderItem(doc.root)
	}
	RenderItem(item:Item):map:void = {
		if (item.type == `root) {
			this.RenderItem(item.children)
		} elsif (item.type == `h1) {
			this.indices[0] += 1
			this.indices[1..5] = 0
			this.text = ''
			this.RenderItem(item.children)
			this.handler(0, this.indices, this.MakeAnchorName([this.indices[0]]), this.text)
			this.text = nil
		} elsif (item.type == `h2) {
			this.indices[1] += 1
			this.indices[2..5] = 0
			this.text = ''
			this.RenderItem(item.children)
			this.handler(1, this.indices, this.MakeAnchorName(this.indices[0..1]), this.text)
			this.text = nil
		} elsif (item.type == `h3) {
			this.indices[2] += 1
			this.indices[3..5] = 0
			this.text = ''
			this.RenderItem(item.children)
			this.handler(2, this.indices, this.MakeAnchorName(this.indices[0..2]), this.text)
			this.text = nil
		} elsif (item.type == `h4) {
			this.indices[3] += 1
			this.indices[4..5] = 0
			this.text = ''
			this.RenderItem(item.children)
			this.handler(3, this.indices, this.MakeAnchorName(this.indices[0..3]), this.text)
			this.text = nil
		} elsif (item.type == `h5) {
			this.indices[4] += 1
			this.indices[5] = 0
			this.text = ''
			this.RenderItem(item.children)
			this.handler(4, this.indices, this.MakeAnchorName(this.indices[0..4]), this.text)
			this.text = nil
		} elsif (item.type == `h6) {
			this.indices[5] += 1
			this.text = ''
			this.RenderItem(item.children)
			this.handler(5, this.indices, this.MakeAnchorName(this.indices[0..5]), this.text)
			this.text = nil
		} elsif (item.type == `p) {
			// nothing to do
		} elsif (item.type == `blockquote) {
			// nothing to do
		} elsif (item.type == `em) {
			this.RenderItem(item.children)
		} elsif (item.type == `strong) {
			this.RenderItem(item.children)
		} elsif (item.type == `strike) {
			//this.RenderItem(item.children)
		} elsif (item.type == `codeblock) {
			// nothing to do
		} elsif (item.type == `ol) {
			// nothing to do
		} elsif (item.type == `ul) {
			// nothing to do
		} elsif (item.type == `li) {
			// nothing to do
		} elsif (item.type == `line) {
			// nothing to do
		} elsif (item.type == `a) {
			this.RenderItem(item.children)
		} elsif (item.type == `img) {
			// nothing to do
		} elsif (item.type == `text) {
			if (this.text) {
				this.text += item.text
			}
		} elsif (item.type == `comment) {
			// nothing to do
		} elsif (item.type == `code) {
			if (this.text) {
				this.text += item.text
			}
		} elsif (item.type == `entity) {
			// nothing to do
		} elsif (item.type == `tag) {
			// nothing to do
		} elsif (item.type == `hr) {
			// nothing to do
		} elsif (item.type == `br) {
			// nothing to do
		}
	}
	MakeAnchorName(indices[]:number) = MakeAnchorNameDef(indices)
}

classref(`Document).render@tex(out:stream:w, title:string = '', author:string = '', date:string = '') = {
	Renderer@tex(out, title, author, date).Render(this)
} %% { `en,
R'''
'''
}

classref(`Document).render@rtf(out?:stream:w, captionIndex:Bool = false) = {
	out = out || sys.stdout
	Renderer@rtf(out, captionIndex).Render(this)
}

classref(`Document).render@console(colorFlag:Bool = true) = {
	Renderer@console(colorFlag).Render(this)
} %% { `en,
R'''
Renders the content of markdown document to the console.

In default, it uses colors to highlight items.
Specify the argument `colorFlag` with `false` to disable the coloring process.
'''
}

classref(`Document).render@toc() {block} = {
	Renderer@toc(block).Render(this)
}

help.renderer('markdown', 'markdown') {|help:help, stream:stream, header_offset:number|
	stream.Print(help.doc)
}

help.presenter('markdown') {|help:help|
	Document(help.doc.reader()).render@console()
}

_funcentry(lang:symbol, func:function, fmt:string):map = {
	str = format('<@gura.funcentry format="%s"', fmt.escapehtml())
	if (help = help@function(func, lang)) {
		str += '>\n'
		str += help.render('markdown')
		if (!str.endswith('\n')) { str += '\n' }
		str += '</@gura.funcentry>\n'
	} else {
		str += ' />\n'
	}
	str
}

_propentry(lang:symbol, propdecl:propdeclaration):map = {
	accessMode = if (propdecl.readable && !propdecl.writable) {
		'read-only'
	} elsif (!propdecl.readable && propdecl.writable) {
		'write-only'
	} elsif (propdecl.readable && propdecl.writable) {
		'read/write'
	} else {
		''
	}
	fmt = propdecl.fullname
	str = format('<@gura.propentry format="%s" type="%s" access="%s"',
				 fmt.escapehtml(), propdecl.type, accessMode)
	if (help = propdecl.gethelp(lang)) {
		str += '>\n'
		str += help.render('markdown')
		if (!str.endswith('\n')) { str += '\n' }
		str += '</@gura.propentry>\n'
	} else {
		str += ' />\n'
	}
	str
}

makedoc@module(lang:symbol, moduleName:string, headeroff?:number) = {
	moduleName += '.doc'
	mod = import(&moduleName)
	if (headeroff) {
		str = format('<gura.headerdown%d />\n', headeroff)
		str += mod.__doc@markdown__(lang)
		str += format('<gura.headerup%d />\n', headeroff)
	} else {
		str = mod.__doc@markdown__(lang)
	}
}

makedoc@class(lang:symbol, cls:class, headeroff?:number):dynamic_scope = {
	// The attribute :dynamic_scope is necessary when the help document contains template in it
	// that is expected to be evaluated with the outer environment.
	if (headeroff) {
		str = format('<gura.headerdown%d />\n', headeroff)
		str += help@class(cls, lang).doc
		str += format('<gura.headerup%d />\n', headeroff)
	} else {
		str = help@class(cls, lang).doc
	}
}

makedoc@function(lang:symbol, funcs*:function) = {
	funcs = funcs.each()
	_funcentry(lang, funcs, function.getformat(funcs))
}

makedoc@function$(lang:symbol, match:string, sub:string, funcs*:function) = {
	funcs = funcs.each()
	_funcentry(lang, funcs, function.getformat(funcs):*replace(match, sub))
}

makedoc@property(lang:symbol, obj) = {
	_propentry(lang, obj.__propdecls__())
}

main(mod:environment) = {
	import(argopt)
	argopt.Parser {|p|
		p.addParam('lang', 'l', 'the language of the document', 'value', 'en')
		try {
			[cfg, argv] = p.parse(sys.argv)
		} catch {|e|
			sys.stderr.Println(e.text)
			sys.exit(1)
		}
	}
	fmt = if (argv.len() == 0) { 'html' } else { argv[0] }
	lang = cfg['lang'].tosymbol()
	out = sys.stdout
	doc = markdown.Document()
	doc << mod.__doc@markdown__(lang)
	if (fmt == 'html') {
		doc.render@html(out, true)
	} elsif (fmt == 'tex') {
		doc.render@tex(out)
	} elsif (fmt == 'rtf') {
		doc.render@rtf(out)
	} else {
		sys.stderr.Println('unknown format: ', fmt)
	}
}

document_server(mod:environment, d:dict) = {
	mod.__doc@markdown__(lang:symbol) = {
		d.get(lang, d[d.keys().next()])
	}
	if (mod.__name__ == '__main__') {
		main(mod)
	}
} %% {`en, R'''
Registers a dictionary of document texts written in Markdown format
that are associated with language symbols as their keys.

The argument `mod` takes an `environment` instance referring to the module
envioronemnt in which the documents are provided.
You should usually specify `locals()` for that argument.

Below is an example to call this function:

    text@en = '..'
    text@ja = '..'
    text@fr = '..'
    register(locals(), %{
        `en => text@en
        `ja => text@ja
        `fr => text@fr
	})

It creates a module function that has the following format:

    write(doc:markdown.Document, lang:symbol)

The argument `doc` is a `markdown.document` instance into which the document is poured.

The argument `lang` is a symbol that specifies the language.
'''}
*/
