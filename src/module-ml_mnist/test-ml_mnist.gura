#!/usr/bin/env gurax
//==============================================================================
// test-ml_mnist.gura
//==============================================================================
import(util.tester) {*}
import(ml.mnist)
import(ml.qmnist)

db = ml.mnist.Database('../../sample/resource/mnist')
dbQ = ml.qmnist.Database('../../sample/resource/qmnist')

TestCase('Basic test') {
	Printf('MNIST: nRows=%d, nCols=%d, nClasses=%d\n', db.nRows, db.nCols, db.nClasses)
	Printf('%s\n', db.train.imageSet)
	Printf('%s\n', db.train.labelSet)
	Printf('%s\n', db.test.imageSet)
	Printf('%s\n', db.test.labelSet)
	Printf('QMNIST: nRows=%d, nCols=%d, nClasses=%d\n', dbQ.nRows, dbQ.nCols, dbQ.nClasses)
	Printf('%s\n', dbQ.train.imageSet)
	Printf('%s\n', dbQ.train.labelSet)
	Printf('%s\n', dbQ.test.imageSet)
	Printf('%s\n', dbQ.test.labelSet)
}

TestCase('ml.mnist.SampleSet#EachBatch()') {
	[db, dbQ]:*train:*EachBatch(`float, 3)::Head(2) {|sample|
		repeat (sample.input.shape[0]) {|i|
			Println(sample.labels[i])
			ml.mnist.PrintImage(sample.input[i], guideFlag = false)
		}
	}
}

TestCase('ml.mnist.SampleSet#Shuffle()') {
	rand = Random(0)
	repeat (3) {
		db.train.Shuffle(rand)
		sample = db.train.EachBatch(`float, 32).NextValue()
		Println(sample.labels.Each():iter {|label| Format('%d', label)}.Join(','))
	}
}
