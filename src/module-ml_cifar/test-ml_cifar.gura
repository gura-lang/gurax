#!/usr/bin/env gurax
//==============================================================================
// test-ml_cifar.gura
//==============================================================================
import(util.tester) {*}
import(tar)
import(png)
import(ml.cifar)
import(ml.cifar10)
import(ml.cifar100)

Println('Reading Cifar10')
db10 = ml.cifar10.Database('.')
Println('Reading Cifar100')
db100 = ml.cifar100.Database('.')

TestCase('Basic test') {
	Printf('Cifar10: nChannels=%d, nRows=%d, nCols=%d, nClasses=%d\n', db10.nChannels, db10.nRows, db10.nCols, db10.nClasses)
	Printf('Cifar100: nChannels=%d, nRows=%d, nCols=%d, nClasses=%d\n', db100.nChannels, db100.nRows, db100.nCols, db100.nClasses)
	//Printf('%s\n', db10.train.imageSet)
	//Printf('%s\n', db10.train.labelSet)
	//Printf('%s\n', db10.test.imageSet)
	//Printf('%s\n', db10.test.labelSet)
	//Printf('%s\n', db100.train.imageSet)
	//Printf('%s\n', db100.train.labelSet)
	//Printf('%s\n', db100.test.imageSet)
	//Printf('%s\n', db100.test.labelSet)
}

TestCase('ml.cifar.SampleSet#Each()') {
	[db10, db100].Each {|db|
		db.train.Each(`float).Head(8 * 3) {|sample|
			//Println(db.labelNames[sample.label])
			if (sample.hasSuperClass) {
				Printf('%s : %s\n', sample.labelName, sample.labelNameSuper)
			} else {
				Printf('%s\n', sample.labelName)
			}
			ml.cifar.PrintImage(sample.input, guideFlag = false)
		}
	}
}

TestCase('ml.cifar.SampleSet#EachBatch()') {
	[db10, db100].Each {|db|
		db.train.EachBatch(8, `float).Head(3) {|sample|
			repeat (sample.input.shape[0]) {|i|
				if (sample.hasSuperClass) {
					Printf('%s : %s\n', sample.labelNames[i], sample.labelNamesSuper[i])
				} else {
					Printf('%s\n', sample.labelNames[i])
				}
				ml.cifar.PrintImage(sample.input[i], guideFlag = false)
			}
		}
	}
}

TestCase('ml.cifar.SampleSet#Get()') {
	[db10, db100].Each {|db|
		repeat (8 * 3) {|i|
			sample = db.train.Get(i, `float)
			if (sample.hasSuperClass) {
				Printf('%s : %s\n', sample.labelName, sample.labelNameSuper)
			} else {
				Printf('%s\n', sample.labelName)
			}
			ml.cifar.PrintImage(sample.input, guideFlag = false)
		}
	}
}

TestCase('ml.cifar.SampleSet#Shuffle()') {
	rand = Random(0)
	[db10, db100].Each {|db|
		repeat (3) {
			db.train.Shuffle(rand)
			sample = db.train.EachBatch(32, `float).NextValue()
			Println(sample.labels.Each():iter {|label| Format('%d', label)}.Join(','))
		}
	}
}
