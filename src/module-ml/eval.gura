#!/usr/bin/env gurax
import(recog_mnist)
import(ml.mnist)

db = ml.mnist.Database('../../sample/resource/mnist')
nCorrects = 0
nSamples = db.test.nSamples
Printf('Test with %d samples\n', nSamples)
db.test.Each(`float) {|pair|
	[image, label] = pair
	image = image.Reshape(recog_mnist.shapeImage*)
	result = recog_mnist.Eval(image)
	idxResult = result.ArgMax(-1, 0)
	idxLabel = label.ArgMax()
	if (idxResult == idxLabel) {
		//Printf(' "%d" .. correct with likelihood %.1f%%\n', idxResult, y[0, idxResult] * 100)
		nCorrects += 1
	} else {
		//arrayImage[i].ToList().Fold(db.test.imageSet.nCols) {|row| Printf('%s\n', pattern.Get(row * 4).Join())}
		//Printf(' "%d" .. wrong. correct is "%d"\n', idxResult, idxLabel)
	}
}
sys.cerr.Printf('accuracy: %d/%d (%.1f%%)\n', nCorrects, nSamples, nCorrects / nSamples * 100)
